#!/usr/bin/env bash

if [[ -z $DOTFILES_PATH ]]; then
	echo "Environment variable (DOTFILES_PATH) is not set" >&2
	exit 1
fi

. "$DOTFILES_PATH/lib/log.sh" || exit $?
. "$DOTFILES_PATH/lib/utils.sh" || exit $?

function link_dotfiles() {
	echo "Setting up dotfiles"

	local dotfiles=(.bash_profile .bashrc .gitconfig .imwheelrc .inputrc .npmrc .tmux.conf)

	for file in "${dotfiles[@]}"; do
		ln -fs "$DOTFILES_PATH/$file" "$HOME"
	done

	mkdir -p "$HOME"/.bashrc.d
	ln -fs "$DOTFILES_PATH"/.bashrc.d/* "$HOME"/.bashrc.d

	mkdir -p "$HOME"/.profile.d
	ln -fs "$DOTFILES_PATH"/.profile.d/* "$HOME"/.profile.d
}

function generate_env_vars() {
	echo "Generating environment variables"

	if is_fedora; then
		POWERLINE_BASH_CONFIG="/usr/share/powerline/bash/powerline.sh"
		POWERLINE_TMUX_CONFIG="/usr/share/tmux/powerline.conf"
	elif is_ubuntu; then
		POWERLINE_BASH_CONFIG="/usr/share/powerline/bindings/bash/powerline.sh"
		POWERLINE_TMUX_CONFIG="/usr/share/powerline/bindings/tmux/powerline.conf"
	fi

	mkdir -p ~/.profile.d

	printf '%s\n\n%s\n%s\n%s\n' \
		'# Code generated by dotfiles.' \
		"export DOTFILES_PATH='$DOTFILES_PATH'" \
		"export POWERLINE_BASH_CONFIG='$POWERLINE_BASH_CONFIG'" \
		"export POWERLINE_TMUX_CONFIG='$POWERLINE_TMUX_CONFIG'" >~/.profile.d/exports.df.sh
}

function link_autostart_config() {
	is_linux || return 1

	echo "Setting up autostart applications"

	local autostart_config_dir="$HOME/.config/autostart/"

	mkdir -p "$autostart_config_dir"
	ln -fs "$DOTFILES_PATH"/config/autostart/* "$autostart_config_dir"
}

function link_htop_config() {
	echo "Setting up htop configuration"

	local htop_config_dir="$HOME/.config/htop/"

	mkdir -p "$htop_config_dir"
	ln -fs "$DOTFILES_PATH"/config/htop/* "$htop_config_dir"
}

function link_powerline_config() {
	echo "Setting up powerline configuration"

	local powerline_config_dir="$HOME/.config/powerline/"

	mkdir -p "$powerline_config_dir"
	ln -fs "$DOTFILES_PATH"/config/powerline/* "$powerline_config_dir"
}

function link_alacritty_config() {
	echo "Setting up alacritty configuration"

	local alacritty_config_dir="$HOME/.config/alacritty/"

	mkdir -p "$alacritty_config_dir"
	ln -fs "$DOTFILES_PATH"/config/alacritty/* "$alacritty_config_dir"
}

function link_lazygit_config() {
	echo "Setting up lazygit configuration"

	local lazygit_config_dir="$HOME/.config/lazygit/"

	mkdir -p "$lazygit_config_dir"
	ln -fs "$DOTFILES_PATH"/config/lazygit/* "$lazygit_config_dir"
}

function main() {
	link_dotfiles
	generate_env_vars
	link_autostart_config
	link_htop_config
	link_powerline_config
	link_alacritty_config
	link_lazygit_config
}

main "$@"
